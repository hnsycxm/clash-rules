name: Build MRS
on:
  push:
    paths:
      - domain.txt
  workflow_dispatch: {}
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Generate rules.yaml
        run: |
          if [ ! -f domain.txt ]; then
            echo "::error::domain.txt not found"
            ls -la
            exit 1
          fi
          python3 <<'PYEOF'
import sys
with open("domain.txt") as f:
  domains = [f"  - '+.{line.strip().lstrip('*.')}'" 
             for line in f 
             if line.strip() and not line.startswith(("#","//")) and "." in line]
if not domains:
  print("::error::No valid domains", file=sys.stderr)
  sys.exit(1)
with open("rules.yaml","w") as o:
  o.write("payload:\n" + "\n".join(domains) + "\n")
print(f"::notice::Generated {len(domains)} rules", file=sys.stderr)
PYEOF
          head -3 rules.yaml
      - name: Compile MRS via Docker
        run: |
          docker run --rm -v " $ (pwd):/work" -w /work \
            ghcr.io/metacubex/clash-meta:latest \
            rule-set compile --input rules.yaml --output rules.mrs
          ls -lh rules.mrs
      - uses: actions/upload-artifact@v4
        with:
          name: rules-mrs
          path: rules.mrs
      - name: Commit MRS
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add rules.mrs
          git diff --quiet rules.mrs || git commit -m "Update rules.mrs" && git push
