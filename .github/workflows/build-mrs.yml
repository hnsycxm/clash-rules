name: Build MRS
on: [push, workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    permissions: {contents: write}
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ”§ ç”Ÿæˆ YAML è§„åˆ™é›†
        run: |
          if [ ! -f domain.txt ]; then
            echo "::error::âŒ æœªæ‰¾åˆ° domain.txtï¼"
            ls -l
            exit 1
          fi
          python -c '''
import sys
with open("domain.txt") as f:
  domains = [f"  - '+.{line.strip().lstrip('*.')}'" 
             for line in f 
             if line.strip() and not line.startswith(("#","//")) and "." in line]
if not domains:
  print("âŒ æ— æœ‰æ•ˆåŸŸå", file=sys.stderr)
  sys.exit(1)
with open("rules.yaml","w") as o:
  o.write("payload:\n" + "\n".join(domains))
print(f"âœ… ç”Ÿæˆ {len(domains)} æ¡è§„åˆ™", file=sys.stderr)
'''
          head -3 rules.yaml
      
      - name: ğŸ³ ç”¨ Docker ç¼–è¯‘ MRSï¼ˆç»ˆææ–¹æ¡ˆï¼‰
        run: |
          docker run --rm -v  $ (pwd):/work -w /work \
            ghcr.io/metacubex/clash-meta:latest \
            rule-set compile \
              --input rules.yaml \
              --output rules.mrs
          ls -lh rules.mrs
          file rules.mrs
      
      - uses: actions/upload-artifact@v4
        with: {name: mrs, path: rules.mrs}
      
      - run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rules.mrs
          git diff --quiet rules.mrs || (git commit -m "Update" && git push)
