name: Build MRS
on: [push, workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    permissions: {contents: write}
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ”§ è½¬æ¢åŸŸå
        run: |
          python converter.py
          echo "ğŸ” éªŒè¯ YAML å†…å®¹:"
          head -5 rules.yaml
          if [ ! -s rules.yaml ]; then
            echo "::error::YAML ä¸ºç©ºï¼"
            exit 1
          fi
      
      - name: â¬‡ï¸ è·å– Clash.Meta
        run: |
          wget -q https://github.com/MetaCubeX/Clash.Meta/releases/download/v1.13.0/Clash.Meta-linux-amd64.tar.gz
          tar -xzf Clash.Meta-linux-amd64.tar.gz
          chmod +x clash
          ./clash -version
      
      - name: ğŸ” ç¼–è¯‘ MRSï¼ˆç²¾ç¡®å‘½ä»¤ï¼‰
        run: |
          ./clash rule-set compile \
            --input rules.yaml \
            --output rules.mrs
          ls -lh rules.mrs
          file rules.mrs
      
      - uses: actions/upload-artifact@v4
        with: {name: mrs, path: rules.mrs}
      
      - run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rules.mrs
          git diff --quiet rules.mrs || (git commit -m "Update" && git push)
